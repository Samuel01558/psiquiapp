<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIE-10 - PsiquiApp</title>
    
    <!-- Bootstrap 5.3.0 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="/css/bootstrap-custom-psiqui.css" rel="stylesheet">
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="dashboard.html">
                <i class="fas fa-brain me-2"></i>
                PsiquiApp
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-tachometer-alt me-1"></i>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32'%3E%3Crect width='32' height='32' fill='%234A7C59'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='14' fill='%23ffffff'%3EDR%3C/text%3E%3C/svg%3E" class="rounded-circle me-2" alt="Doctor Avatar" id="doctorAvatar">
                            <span id="doctorName" class="d-none d-sm-inline">Dr. Admin</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="perfil.html"><i class="fas fa-user me-2"></i>Perfil</a></li>
                            <li><a class="dropdown-item" href="configuracion.html"><i class="fas fa-cog me-2"></i>Configuración</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="login.html"><i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar bg-white shadow-sm">
                <div class="sidebar-header">
                    <h5 class="mb-0">
                        <i class="fas fa-th-list me-2" aria-hidden="true"></i>
                        MENÚ PRINCIPAL
                    </h5>
                </div>
                <ul class="sidebar-menu">
                    <li class="sidebar-item">
                        <a href="dashboard.html" class="sidebar-link">
                            <i class="fas fa-th-large sidebar-icon"></i>
                            Dashboard
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="pacientes.html" class="sidebar-link">
                            <i class="fas fa-users sidebar-icon"></i>
                            Pacientes
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="consultas.html" class="sidebar-link">
                            <i class="fas fa-notes-medical sidebar-icon"></i>
                            Consultas
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="recetas.html" class="sidebar-link">
                            <i class="fas fa-prescription-bottle-alt sidebar-icon"></i>
                            Recetas Médicas
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="dsm5.html" class="sidebar-link">
                            <i class="fas fa-book sidebar-icon"></i>
                            Guía DSM-5
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="cie10.html" class="sidebar-link active">
                            <i class="fas fa-clipboard-list sidebar-icon"></i>
                            CIE-10
                        </a>
                    </li>
                    <li class="sidebar-item">
                        <a href="tests.html" class="sidebar-link">
                            <i class="fas fa-clipboard-check sidebar-icon"></i>
                            Test Psicométricos
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Main Content Area -->
            <div class="col-md-9 col-lg-10 main-content">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center py-3 mb-4 border-bottom">
                    <h1 class="h3 mb-0 text-primary">
                        <i class="fas fa-clipboard-list me-2"></i>
                        Clasificación Internacional de Enfermedades (CIE-10)
                    </h1>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#searchModal">
                            <i class="fas fa-search me-1"></i>
                            Buscar Código
                        </button>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#converterModal">
                            <i class="fas fa-exchange-alt me-1"></i>
                            Convertir DSM-5
                        </button>
                    </div>
                </div>

                <!-- Search Bar -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="fas fa-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control border-start-0" 
                                   placeholder="Buscar código CIE-10, enfermedad o síntoma..." id="searchInput">
                        </div>
                    </div>
                </div>

                <!-- CIE-10 Chapters (dynamic from cie10.js) -->
                <div class="row" id="chaptersContainer">
                    <!-- Las tarjetas se cargarán dinámicamente desde cie10.js -->
                </div>



                <!-- Most Used Codes (dynamic) -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h4 class="mb-3">Códigos Más Utilizados</h4>
                    </div>
                    <div class="col-12" id="mostUsedCodesContainer">
                        <!-- Las tarjetas se cargarán dinámicamente desde cie10.js -->
                    </div>
                </div>

                <!-- Quick Tools -->
                <div class="row mt-5">
                    <div class="col-12">
                        <h4 class="mb-3">Herramientas</h4>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-0 bg-primary-subtle">
                            <div class="card-body text-center">
                                <i class="fas fa-search fa-2x text-primary mb-2"></i>
                                <h6 class="card-title">Búsqueda Avanzada</h6>
                                <button class="btn btn-sm btn-primary" onclick="openAdvancedSearch()">
                                    Buscar
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-0 bg-secondary-subtle">
                            <div class="card-body text-center">
                                <i class="fas fa-exchange-alt fa-2x text-secondary mb-2"></i>
                                <h6 class="card-title">Convertir DSM-5</h6>
                                <button class="btn btn-sm btn-secondary" onclick="openConverter()">
                                    Convertir
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-0 bg-warning-subtle">
                            <div class="card-body text-center">
                                <i class="fas fa-external-link-alt fa-2x text-warning mb-2"></i>
                                <h6 class="card-title">Navegador CIE-10</h6>
                                <button class="btn btn-sm btn-warning" onclick="downloadManual()">
                                    Abrir OMS
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-0 bg-info-subtle">
                            <div class="card-body text-center">
                                <i class="fas fa-history fa-2x text-info mb-2"></i>
                                <h6 class="card-title">Códigos Recientes</h6>
                                <button class="btn btn-sm btn-info" onclick="showRecent()">
                                    Ver Historial
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div class="modal fade" id="searchModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-search me-2"></i>
                        Búsqueda de Códigos CIE-10
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Código CIE-10:</label>
                        <input type="text" id="advancedSearchCode" class="form-control" placeholder="Ej: F32.9, F41.1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción:</label>
                        <input type="text" id="advancedSearchDesc" class="form-control" placeholder="Nombre de la enfermedad o trastorno">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Capítulo:</label>
                        <select id="advancedSearchChapter" class="form-select">
                            <option value="">Seleccionar capítulo</option>
                            <option value="F00-F09">F00-F09: Trastornos mentales orgánicos</option>
                            <option value="F10-F19">F10-F19: Trastornos por uso de sustancias</option>
                            <option value="F20-F29">F20-F29: Esquizofrenia y trastornos psicóticos</option>
                            <option value="F30-F39">F30-F39: Trastornos del estado de ánimo</option>
                            <option value="F40-F48">F40-F48: Trastornos neuróticos</option>
                            <option value="F60-F69">F60-F69: Trastornos de la personalidad</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal" style="height: 38px; border-radius: 4px;">Cancelar</button>
                    <button type="button" class="btn btn-primary px-4" onclick="performAdvancedSearch()" style="height: 38px; border-radius: 4px;">Buscar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Converter Modal -->
    <div class="modal fade" id="converterModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exchange-alt me-2"></i>
                        Convertir DSM-5 a CIE-10
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Código o diagnóstico DSM-5:</label>
                        <input type="text" class="form-control" id="dsmInput" placeholder="Ej: 315.00, Major Depressive Disorder, 296.33">
                    </div>
                    <div id="conversionResult" style="display: none;">
                        <!-- Resultado se mostrará aquí -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="convertDSMtoCIE()">Convertir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Functional CIE-10 Manager -->
    <script src="/js/cie10.js"></script>

    <!-- Demo hook: ?demo=f32 busca y abre el primer resultado -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Cargar códigos más utilizados
            if (window.cie10Manager) {
                window.cie10Manager.loadMostUsedCodes();
            }

            // Fix para warning de accesibilidad: devolver foco al cerrar modales
            const searchModal = document.getElementById('searchModal');
            const conditionModal = document.getElementById('conditionModal');
            const converterModal = document.getElementById('converterModal');

            if (searchModal) {
                searchModal.addEventListener('hidden.bs.modal', function () {
                    // Devolver foco al input de búsqueda principal
                    const mainSearchInput = document.getElementById('searchInput');
                    if (mainSearchInput) {
                        mainSearchInput.focus();
                    }
                });
            }

            if (conditionModal) {
                conditionModal.addEventListener('hidden.bs.modal', function () {
                    // Devolver foco al contenedor principal
                    const mainContent = document.querySelector('.main-content');
                    if (mainContent) {
                        mainContent.setAttribute('tabindex', '-1');
                        mainContent.focus();
                        mainContent.removeAttribute('tabindex');
                    }
                });
            }

            if (converterModal) {
                converterModal.addEventListener('hidden.bs.modal', function () {
                    // Devolver foco al botón que abrió el modal
                    const converterButton = document.querySelector('[onclick="openConverter()"]');
                    if (converterButton) {
                        converterButton.focus();
                    }
                });
            }

            // Agregar listener para Enter en campos de búsqueda avanzada
            const advancedSearchCode = document.getElementById('advancedSearchCode');
            const advancedSearchDesc = document.getElementById('advancedSearchDesc');
            
            if (advancedSearchCode) {
                advancedSearchCode.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        performAdvancedSearch();
                    }
                });
            }
            
            if (advancedSearchDesc) {
                advancedSearchDesc.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        performAdvancedSearch();
                    }
                });
            }

            const params = new URLSearchParams(window.location.search);
            const demo = params.get('demo');
            if (demo && window.cie10Manager) {
                const term = demo === '1' ? 'F32' : demo;
                setTimeout(() => {
                    window.cie10Manager.performSearch(term);
                    // Intentar abrir detalles del primer resultado tras renderizado
                    setTimeout(() => {
                        const firstBtn = document.querySelector('.condition-btn');
                        if (firstBtn) firstBtn.click();
                    }, 150);
                }, 100);
            }
        });

        // Función para abrir búsqueda avanzada
        function openAdvancedSearch() {
            const modal = new bootstrap.Modal(document.getElementById('searchModal'));
            modal.show();
        }

        // Función para realizar búsqueda avanzada
        function performAdvancedSearch() {
            const code = document.getElementById('advancedSearchCode').value.trim().toLowerCase();
            const description = document.getElementById('advancedSearchDesc').value.trim().toLowerCase();
            const chapter = document.getElementById('advancedSearchChapter').value;

            // Validar que al menos un campo tenga valor
            if (!code && !description && !chapter) {
                showMessage('Por favor ingrese al menos un criterio de búsqueda', 'warning');
                return;
            }

            // Cerrar modal de búsqueda
            const searchModal = bootstrap.Modal.getInstance(document.getElementById('searchModal'));
            if (searchModal) {
                searchModal.hide();
            }

            // Si hay código, buscar directamente
            if (code) {
                // Buscar en showChapter primero si es un código completo
                if (code.match(/^f\d+/i)) {
                    const codeUpper = code.toUpperCase();
                    
                    // Buscar el capítulo al que pertenece
                    const chapterRanges = {
                        'F00-F09': /^F0[0-9]$/i,
                        'F10-F19': /^F1[0-9]$/i,
                        'F20-F29': /^F2[0-9]$/i,
                        'F30-F39': /^F3[0-9]$/i,
                        'F40-F48': /^F4[0-8]$/i,
                        'F60-F69': /^F6[0-9]$/i
                    };

                    let foundChapter = null;
                    for (const [range, pattern] of Object.entries(chapterRanges)) {
                        if (pattern.test(codeUpper)) {
                            foundChapter = range;
                            break;
                        }
                    }

                    if (foundChapter) {
                        showChapter(foundChapter);
                        
                        // Resaltar el código buscado después de un breve delay
                        setTimeout(() => {
                            const rows = document.querySelectorAll('.code-row');
                            rows.forEach(row => {
                                const codeCell = row.querySelector('td:first-child strong');
                                if (codeCell && codeCell.textContent.toLowerCase().includes(code)) {
                                    row.style.backgroundColor = '#fff3cd';
                                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                            });
                        }, 500);
                        return;
                    }
                }

                // Si no se encontró, hacer búsqueda general
                if (window.cie10Manager) {
                    window.cie10Manager.performSearch(code);
                }
                return;
            }

            // Si hay descripción, buscar por descripción
            if (description && window.cie10Manager) {
                window.cie10Manager.performSearch(description);
                return;
            }

            // Si solo hay capítulo, mostrar ese capítulo
            if (chapter) {
                showChapter(chapter);
            }
        }

        // Función para abrir convertidor DSM-5 a CIE-10
    function openConverter() {
        const modal = new bootstrap.Modal(document.getElementById('converterModal'));
        modal.show();
    }

    // Base de datos de conversión DSM-5 a CIE-10
    const dsmToCie10Mapping = {
        // Trastornos Depresivos
        '296.20': { cie10: 'F32.9', desc: 'Episodio depresivo sin especificación' },
        '296.21': { cie10: 'F32.0', desc: 'Episodio depresivo leve' },
        '296.22': { cie10: 'F32.1', desc: 'Episodio depresivo moderado' },
        '296.23': { cie10: 'F32.2', desc: 'Episodio depresivo grave sin síntomas psicóticos' },
        '296.24': { cie10: 'F32.3', desc: 'Episodio depresivo grave con síntomas psicóticos' },
        '296.30': { cie10: 'F33.9', desc: 'Trastorno depresivo recurrente sin especificación' },
        '296.31': { cie10: 'F33.0', desc: 'Trastorno depresivo recurrente, episodio actual leve' },
        '296.32': { cie10: 'F33.1', desc: 'Trastorno depresivo recurrente, episodio actual moderado' },
        '296.33': { cie10: 'F33.2', desc: 'Trastorno depresivo recurrente, episodio actual grave sin síntomas psicóticos' },
        
        // Trastornos de Ansiedad
        '300.01': { cie10: 'F41.0', desc: 'Trastorno de pánico' },
        '300.02': { cie10: 'F41.1', desc: 'Trastorno de ansiedad generalizada' },
        '300.21': { cie10: 'F40.10', desc: 'Fobia social sin especificación' },
        '300.22': { cie10: 'F40.00', desc: 'Agorafobia' },
        '300.23': { cie10: 'F40.218', desc: 'Fobia específica' },
        '300.3': { cie10: 'F42.9', desc: 'Trastorno obsesivo-compulsivo' },
        
        // Trastornos del Espectro de la Esquizofrenia
        '295.90': { cie10: 'F20.9', desc: 'Esquizofrenia sin especificación' },
        '295.10': { cie10: 'F20.0', desc: 'Esquizofrenia paranoide' },
        '295.20': { cie10: 'F20.1', desc: 'Esquizofrenia catatónica' },
        '295.30': { cie10: 'F20.3', desc: 'Esquizofrenia indiferenciada' },
        '295.60': { cie10: 'F20.5', desc: 'Esquizofrenia residual' },
        '295.70': { cie10: 'F25.9', desc: 'Trastorno esquizoafectivo' },
        
        // Trastornos Bipolares
        '296.40': { cie10: 'F31.9', desc: 'Trastorno bipolar sin especificación' },
        '296.41': { cie10: 'F31.1', desc: 'Trastorno bipolar, episodio maníaco leve' },
        '296.42': { cie10: 'F31.2', desc: 'Trastorno bipolar, episodio maníaco moderado' },
        '296.43': { cie10: 'F31.2', desc: 'Trastorno bipolar, episodio maníaco grave sin síntomas psicóticos' },
        '296.44': { cie10: 'F31.2', desc: 'Trastorno bipolar, episodio maníaco grave con síntomas psicóticos' },
        '296.80': { cie10: 'F31.81', desc: 'Trastorno bipolar tipo II' },
        
        // TDAH y Trastornos del Neurodesarrollo
        '314.00': { cie10: 'F90.0', desc: 'TDAH, tipo predominantemente inatento' },
        '314.01': { cie10: 'F90.1', desc: 'TDAH, tipo predominantemente hiperactivo-impulsivo' },
        '314.02': { cie10: 'F90.2', desc: 'TDAH, tipo combinado' },
        '315.00': { cie10: 'F81.0', desc: 'Trastorno específico del aprendizaje con dificultad en la lectura' },
        '315.1': { cie10: 'F81.2', desc: 'Trastorno específico del aprendizaje con dificultad matemática' },
        '315.2': { cie10: 'F81.81', desc: 'Trastorno específico del aprendizaje con dificultad en la expresión escrita' },
        '315.39': { cie10: 'F80.9', desc: 'Trastorno de la comunicación sin especificación' },
        '299.00': { cie10: 'F84.0', desc: 'Trastorno del espectro autista' },
        
        // Trastornos de la Personalidad
        '301.0': { cie10: 'F60.0', desc: 'Trastorno paranoide de la personalidad' },
        '301.20': { cie10: 'F60.1', desc: 'Trastorno esquizoide de la personalidad' },
        '301.22': { cie10: 'F21', desc: 'Trastorno esquizotípico de la personalidad' },
        '301.7': { cie10: 'F60.2', desc: 'Trastorno antisocial de la personalidad' },
        '301.83': { cie10: 'F60.3', desc: 'Trastorno límite de la personalidad' },
        '301.50': { cie10: 'F60.4', desc: 'Trastorno histriónico de la personalidad' },
        '301.81': { cie10: 'F60.81', desc: 'Trastorno narcisista de la personalidad' },
        '301.82': { cie10: 'F60.6', desc: 'Trastorno de la personalidad por evitación' },
        '301.6': { cie10: 'F60.7', desc: 'Trastorno de la personalidad por dependencia' },
        '301.4': { cie10: 'F60.5', desc: 'Trastorno obsesivo-compulsivo de la personalidad' },
        
        // Trastornos de Estrés y Trauma
        '309.81': { cie10: 'F43.10', desc: 'Trastorno de estrés postraumático' },
        '308.3': { cie10: 'F43.0', desc: 'Trastorno de estrés agudo' },
        '309.0': { cie10: 'F43.21', desc: 'Trastorno de adaptación con estado de ánimo deprimido' },
        '309.24': { cie10: 'F43.22', desc: 'Trastorno de adaptación con ansiedad' },
        '309.28': { cie10: 'F43.23', desc: 'Trastorno de adaptación con ansiedad mixta y estado de ánimo deprimido' },
        
        // Trastornos Alimentarios
        '307.1': { cie10: 'F50.00', desc: 'Anorexia nerviosa' },
        '307.51': { cie10: 'F50.2', desc: 'Bulimia nerviosa' },
        '307.50': { cie10: 'F50.8', desc: 'Trastorno de atracones' },
        
        // Trastornos por Uso de Sustancias
        '303.90': { cie10: 'F10.20', desc: 'Trastorno por consumo de alcohol' },
        '305.00': { cie10: 'F10.10', desc: 'Consumo de alcohol leve' },
        '304.00': { cie10: 'F11.20', desc: 'Trastorno por consumo de opiáceos' },
        '304.20': { cie10: 'F14.20', desc: 'Trastorno por consumo de cocaína' },
        '304.30': { cie10: 'F12.20', desc: 'Trastorno por consumo de cannabis' },
        '304.40': { cie10: 'F15.20', desc: 'Trastorno por consumo de anfetaminas' }
    };

    function convertDSMtoCIE() {
        const input = document.getElementById('dsmInput').value.trim();
        const resultDiv = document.getElementById('conversionResult');
        
        if (!input) {
            resultDiv.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Por favor, ingresa un código o diagnóstico DSM-5
                </div>
            `;
            resultDiv.style.display = 'block';
            return;
        }

        // Buscar por código exacto primero
        const result = dsmToCie10Mapping[input];
        
        if (result) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6 class="alert-heading">
                        <i class="fas fa-check-circle me-2"></i>
                        Conversión encontrada
                    </h6>
                    <hr>
                    <p class="mb-1"><strong>DSM-5:</strong> ${input}</p>
                    <p class="mb-1"><strong>CIE-10:</strong> ${result.cie10}</p>
                    <p class="mb-0"><strong>Descripción:</strong> ${result.desc}</p>
                </div>
            `;
            resultDiv.style.display = 'block';
        } else {
            // Buscar por descripción parcial
            const searchTerm = input.toLowerCase();
            const matches = Object.entries(dsmToCie10Mapping).filter(([code, data]) => 
                data.desc.toLowerCase().includes(searchTerm) ||
                code.includes(input)
            );

            if (matches.length > 0) {
                let html = `
                    <div class="alert alert-info">
                        <h6 class="alert-heading">
                            <i class="fas fa-search me-2"></i>
                            ${matches.length} resultado(s) encontrado(s)
                        </h6>
                        <hr>
                `;
                
                matches.slice(0, 5).forEach(([code, data]) => {
                    html += `
                        <div class="mb-2 pb-2 border-bottom">
                            <p class="mb-1"><strong>DSM-5:</strong> ${code}</p>
                            <p class="mb-1"><strong>CIE-10:</strong> ${data.cie10}</p>
                            <p class="mb-0"><strong>Descripción:</strong> ${data.desc}</p>
                        </div>
                    `;
                });
                
                if (matches.length > 5) {
                    html += `<p class="mb-0 text-muted"><small>Mostrando 5 de ${matches.length} resultados. Sé más específico para reducir los resultados.</small></p>`;
                }
                
                html += `</div>`;
                resultDiv.innerHTML = html;
                resultDiv.style.display = 'block';
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-2"></i>
                        <strong>No se encontró conversión</strong>
                        <p class="mb-0 mt-2">El código o diagnóstico DSM-5 "${input}" no se encuentra en la base de datos.</p>
                        <small class="text-muted">Intenta con el código numérico completo (ej: 315.00) o una palabra clave del diagnóstico.</small>
                    </div>
                `;
                resultDiv.style.display = 'block';
            }
        }
    }

    // Permitir búsqueda con Enter
    document.addEventListener('DOMContentLoaded', function() {
        const dsmInput = document.getElementById('dsmInput');
        if (dsmInput) {
            dsmInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    convertDSMtoCIE();
                }
            });
        }
    });
</script>    <!-- Condition Modal for Details -->
    <div class="modal fade" id="conditionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="conditionModalTitle">Detalle del Código</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="conditionModalBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
