<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultas - PsiquiApp</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="/css/bootstrap-custom-psiqui.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container-fluid">
            <button class="btn btn-outline-light d-lg-none me-2" type="button" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
            <a class="navbar-brand fw-bold" href="dashboard.html">
                <i class="fas fa-brain me-2"></i>
                PsiquiApp
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-tachometer-alt me-1"></i>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32'%3E%3Crect width='32' height='32' fill='%234A7C59'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='14' fill='%23ffffff'%3EDR%3C/text%3E%3C/svg%3E" class="rounded-circle me-2" alt="Doctor Avatar" id="doctorAvatar">
                            <span id="doctorName" class="d-none d-sm-inline">Dr. Admin</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="perfil.html"><i class="fas fa-user me-2"></i>Perfil</a></li>
                            <li><a class="dropdown-item" href="configuracion.html"><i class="fas fa-cog me-2"></i>Configuración</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="login.html"><i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar bg-white shadow-sm">
                <div class="sidebar-header">
                    <h5 class="mb-0">
                        <i class="fas fa-th-list me-2" aria-hidden="true"></i>
                        MENÚ PRINCIPAL
                    </h5>
                </div>
                <ul class="sidebar-menu">
                <li class="sidebar-item">
                    <a href="dashboard.html" class="sidebar-link">
                        <i class="fas fa-th-large sidebar-icon"></i>
                        Dashboard
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="pacientes.html" class="sidebar-link">
                        <i class="fas fa-users sidebar-icon"></i>
                        Pacientes
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="consultas.html" class="sidebar-link active">
                        <i class="fas fa-notes-medical sidebar-icon"></i>
                        Consultas
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="recetas.html" class="sidebar-link">
                        <i class="fas fa-prescription-bottle-alt sidebar-icon"></i>
                        Recetas Médicas
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="dsm5.html" class="sidebar-link">
                        <i class="fas fa-book sidebar-icon"></i>
                        Guía DSM-5
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="cie10.html" class="sidebar-link">
                        <i class="fas fa-clipboard-list sidebar-icon"></i>
                        CIE-10
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="tests.html" class="sidebar-link">
                        <i class="fas fa-clipboard-check sidebar-icon"></i>
                        Test Psicométricos
                    </a>
                </li>
            </ul>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <div class="container-fluid">
                    <!-- Suspended Account Warning -->
                    <div id="suspendedWarning" class="alert alert-warning alert-dismissible fade show" role="alert" style="display: none;">
                        <h4 class="alert-heading">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Cuenta Suspendida - Modo Solo Lectura
                        </h4>
                        <p class="mb-0">
                            Su cuenta ha sido suspendida por el administrador. Puede visualizar toda la información 
                            pero no podrá realizar modificaciones, agregar o eliminar datos. 
                            Contacte al administrador para más información.
                        </p>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>

                    <!-- Page Header -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h1 class="page-title">
                                <i class="fas fa-notes-medical text-primary mr-3"></i>
                                Gestión de Consultas
                            </h1>
                            <p class="text-muted">Administra las consultas médicas y citas programadas</p>
                        </div>
                    </div>

            <!-- Action Buttons -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-primary" id="newConsultationBtn" onclick="showAddConsultationModal()">
                            <i class="fas fa-plus mr-2"></i>
                            Nueva Consulta
                        </button>
                        <button class="btn btn-outline-success" id="scheduleAppointmentBtn" onclick="showScheduleModal()">
                            <i class="fas fa-calendar-plus mr-2"></i>
                            Programar Cita
                        </button>
                        <button class="btn btn-outline-secondary" id="exportConsultationsBtn" onclick="exportConsultations()">
                            <i class="fas fa-download mr-2"></i>
                            Exportar
                        </button>
                        <button class="btn btn-outline-info" onclick="refreshConsultations()">
                            <i class="fas fa-sync-alt mr-2"></i>
                            Actualizar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Filters Row -->
            <div class="row mb-4">
                <div class="col-lg-4">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-search"></i>
                            </span>
                        </div>
                        <input type="text" class="form-control" id="searchConsultations" placeholder="Buscar consultas...">
                    </div>
                </div>
                <div class="col-lg-2">
                    <select class="form-control" id="filterPatient">
                        <option value="">Todos los pacientes</option>
                        <!-- Options will be loaded dynamically -->
                    </select>
                </div>
                <div class="col-lg-2">
                    <select class="form-control" id="filterStatus">
                        <option value="">Todos los estados</option>
                        <option value="programada">Programada</option>
                        <option value="completada">Completada</option>
                        <option value="cancelada">Cancelada</option>
                    </select>
                </div>
                <div class="col-lg-2">
                    <input type="date" class="form-control" id="filterDate" placeholder="Fecha">
                </div>
                <div class="col-lg-2">
                    <button class="btn btn-outline-secondary btn-block" onclick="clearFilters()">
                        <i class="fas fa-eraser"></i> Limpiar
                    </button>
                </div>
            </div>

            <!-- Consultations Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-light border-bottom">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-list mr-2"></i>
                                Lista de Consultas
                            </h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="thead-light">
                                        <tr>
                                            <th scope="col">ID</th>
                                            <th scope="col">Paciente</th>
                                            <th scope="col">Fecha/Hora</th>
                                            <th scope="col">Tipo</th>
                                            <th scope="col">Estado</th>
                                            <th scope="col">Duración</th>
                                            <th scope="col">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="consultationsTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="sr-only">Cargando...</span>
                                                </div>
                                                <p class="mt-2 mb-0 text-muted">Cargando consultas...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="row mt-4">
                    <div class="col-12">
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center" id="consultationsPagination">
                                <!-- Pagination will be generated dynamically -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Consultation Modal -->
    <div class="modal fade" id="addConsultationModal" tabindex="-1" role="dialog" aria-labelledby="addConsultationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="addConsultationModalLabel">
                        <i class="fas fa-notes-medical mr-2"></i>
                        Nueva Consulta
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addConsultationForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="consultationPatient">Paciente *</label>
                                    <select class="form-control" id="consultationPatient" required>
                                        <option value="">Seleccionar paciente...</option>
                                        <!-- Options will be loaded dynamically -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="consultationDate">Fecha *</label>
                                    <input type="date" class="form-control" id="consultationDate" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="consultationTime">Hora *</label>
                                    <input type="time" class="form-control" id="consultationTime" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="consultationType">Tipo de Consulta</label>
                                    <select class="form-control" id="consultationType">
                                        <option value="Primera vez">Primera vez</option>
                                        <option value="Seguimiento" selected>Seguimiento</option>
                                        <option value="Crisis">Crisis</option>
                                        <option value="Alta">Alta</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="consultationDuration">Duración (minutos)</label>
                                    <input type="number" class="form-control" id="consultationDuration" value="60" min="15" max="240">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="consultationStatus">Estado</label>
                                    <select class="form-control" id="consultationStatus">
                                        <option value="programada">Programada</option>
                                        <option value="completada">Completada</option>
                                        <option value="cancelada">Cancelada</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="consultationMotivo">Motivo de Consulta</label>
                            <textarea class="form-control" id="consultationMotivo" rows="3" placeholder="Describe el motivo de la consulta..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="consultationNotas">Notas Adicionales</label>
                            <textarea class="form-control" id="consultationNotas" rows="4" placeholder="Observaciones, diagnósticos, tratamientos, etc..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveConsultation()">
                        <i class="fas fa-save mr-2"></i>
                        Guardar Consulta
                    </button>
                </div>
            </div>
        </div>
    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery and Bootstrap 5 JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script src="js/consultas.js?v=4.1.0"></script>
    
    <script>
        // ============================================================
        // SCRIPT AUXILIAR - Solo funciones que no están en consultas.js
        // Las funciones principales están en js/consultas.js
        // ============================================================
        
        // Show Add Consultation Modal (Bootstrap 5)
        function showAddConsultationModal() {
            const modal = new bootstrap.Modal(document.getElementById('addConsultationModal'));
            if (document.getElementById('addConsultationForm')) {
                document.getElementById('addConsultationForm').reset();
            }
            // loadPatientsDropdown se llama desde consultas.js
            modal.show();
        }

        // Show Schedule Modal (Bootstrap 5)
        function showScheduleModal() {
            const modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
            if (document.getElementById('scheduleForm')) {
                document.getElementById('scheduleForm').reset();
            }
            modal.show();
        }
        
        // ============================================================
        // NOTA IMPORTANTE:
        // ============================================================
        // Todas las demás funciones (cargar pacientes, cargar consultas,
        // filtros, paginación, etc.) están implementadas en js/consultas.js
        // 
        // NO DUPLICAR CÓDIGO AQUÍ para evitar conflictos.
        // ============================================================
    </script>
</body>
</html>


            if (consultationsData.length === 0) {
                alert('No hay consultas para exportar');
                return;
            }

            const csvContent = generateConsultationsCSV(consultationsData);
            downloadCSV(csvContent, 'consultas.csv');
            showAlert('Consultas exportadas exitosamente', 'success');
        }

        // Generate CSV content for consultations
        function generateConsultationsCSV(data) {
            const headers = ['ID', 'Paciente', 'Fecha', 'Hora', 'Tipo', 'Estado', 'Diagnóstico', 'Notas'];
            const csvRows = [headers.join(',')];
            
            data.forEach(consultation => {
                const patient = patientsData.find(p => p.id === consultation.patientId);
                const patientName = patient ? `${patient.name} ${patient.lastName}` : 'Paciente desconocido';
                
                const row = [
                    consultation.id,
                    patientName,
                    consultation.date,
                    consultation.time,
                    consultation.type || 'Consulta general',
                    consultation.status,
                    consultation.diagnosis || '',
                    consultation.notes || ''
                ];
                csvRows.push(row.map(cell => `"${cell}"`).join(','));
            });
            
            return csvRows.join('\\n');
        }

        // Download CSV file
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Refresh Consultations
        function refreshConsultations() {
            loadConsultationsData();
            renderConsultationsTable();
            showAlert('Datos actualizados', 'info');
        }

        // Clear Filters
        function clearFilters() {
            document.getElementById('searchConsultations').value = '';
            document.getElementById('filterPatient').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterDate').value = '';
            filterConsultations();
            showAlert('Filtros limpiados', 'info');
        }

        // Load consultations data
        function loadConsultationsData() {
            // Cargar consultas desde el servidor
            fetch('/api/consultas')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al cargar consultas');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Consultas cargadas desde el servidor:', data);
                    
                    // Transformar datos del servidor al formato esperado
                    consultationsData = data.consultas.map(c => ({
                        id: c.id,
                        patientId: c.paciente_id,
                        patientName: `${c.paciente_nombre} ${c.paciente_apellido}`,
                        date: c.fecha_consulta,
                        time: c.hora_consulta,
                        type: c.tipo_consulta || 'Consulta general',
                        status: c.estado || 'programada',
                        diagnosis: c.diagnostico || '',
                        notes: c.notas || '',
                        motivo: c.motivo || '',
                        tratamiento: c.tratamiento || '',
                        createdAt: c.created_at
                    }));
                    
                    console.log(`✅ ${consultationsData.length} consultas cargadas correctamente`);
                    
                    filteredConsultations = [...consultationsData];
                    renderConsultationsTable();
                    updateStats();
                })
                .catch(error => {
                    console.error('Error al cargar consultas:', error);
                    
                    // Fallback: usar datos de ejemplo solo si falla la carga
                    consultationsData = generateSampleConsultations();
                    console.warn('⚠️ Usando datos de ejemplo (fallback)');
                    
                    filteredConsultations = [...consultationsData];
                    renderConsultationsTable();
                    updateStats();
                });
        }

        // Load patients data for dropdowns
        function loadPatientsData() {
            // Cargar pacientes desde el servidor
            fetch('/api/pacientes')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al cargar pacientes');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Pacientes cargados desde el servidor:', data);
                    
                    // Transformar datos del servidor al formato esperado
                    patientsData = data.pacientes.map(p => ({
                        id: p.id,
                        name: p.nombre,
                        lastName: p.apellido,
                        email: p.email || '',
                        phone: p.telefono || '',
                        birthDate: p.fecha_nacimiento || '',
                        gender: p.sexo || '',
                        status: p.estado || 'activo'
                    }));
                    
                    console.log(`✅ ${patientsData.length} pacientes cargados correctamente`);
                    
                    // Actualizar dropdowns
                    loadPatientsDropdown();
                })
                .catch(error => {
                    console.error('Error al cargar pacientes:', error);
                    
                    // Fallback: usar datos de ejemplo solo si falla la carga
                    patientsData = [
                        { id: 1, name: 'Juan', lastName: 'Pérez García' },
                        { id: 2, name: 'María', lastName: 'González López' },
                        { id: 3, name: 'Carlos', lastName: 'Martínez Ruiz' }
                    ];
                    
                    console.warn('⚠️ Usando datos de ejemplo (fallback)');
                    loadPatientsDropdown();
                });
        }

        // Generate sample consultations
        function generateSampleConsultations() {
            return [
                {
                    id: 1,
                    patientId: 1,
                    date: '2025-09-30',
                    time: '10:00',
                    type: 'Consulta inicial',
                    status: 'programada',
                    diagnosis: '',
                    notes: 'Primera consulta del paciente',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 2,
                    patientId: 2,
                    date: '2025-09-28',
                    time: '15:30',
                    type: 'Seguimiento',
                    status: 'completada',
                    diagnosis: 'F32.1 - Episodio depresivo moderado',
                    notes: 'Paciente muestra mejoría en el estado de ánimo',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 3,
                    patientId: 3,
                    date: '2025-09-25',
                    time: '09:15',
                    type: 'Urgencia',
                    status: 'cancelada',
                    diagnosis: '',
                    notes: 'Paciente canceló por motivos personales',
                    createdAt: new Date().toISOString()
                }
            ];
        }

        // Load patients dropdown
        function loadPatientsDropdown() {
            const filterSelect = document.getElementById('filterPatient');
            const addSelect = document.getElementById('consultationPatient');
            const scheduleSelect = document.getElementById('schedulePatient');
            
            const options = patientsData.map(patient => 
                `<option value="${patient.id}">${patient.name} ${patient.lastName}</option>`
            ).join('');
            
            if (filterSelect) {
                filterSelect.innerHTML = '<option value="">Todos los pacientes</option>' + options;
            }
            if (addSelect) {
                addSelect.innerHTML = '<option value="">Seleccionar paciente...</option>' + options;
            }
            if (scheduleSelect) {
                scheduleSelect.innerHTML = '<option value="">Seleccionar paciente...</option>' + options;
            }
        }

        // Render consultations table
        function renderConsultationsTable() {
            const tbody = document.getElementById('consultationsTableBody');
            
            if (!tbody) {
                // Create table if it doesn't exist
                const tableContainer = document.querySelector('.table-responsive');
                if (tableContainer) {
                    tableContainer.innerHTML = `
                        <table class="table table-hover mb-0">
                            <thead class="thead-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Paciente</th>
                                    <th>Fecha</th>
                                    <th>Hora</th>
                                    <th>Tipo</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="consultationsTableBody"></tbody>
                        </table>
                    `;
                }
                return renderConsultationsTable(); // Recursive call after creating table
            }
            
            if (filteredConsultations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No se encontraron consultas</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedConsultations = filteredConsultations.slice(start, end);

            tbody.innerHTML = paginatedConsultations.map(consultation => {
                // Usar el nombre del paciente que viene del servidor, o buscarlo en patientsData como fallback
                const patientName = consultation.patientName || 
                    (() => {
                        const patient = patientsData.find(p => p.id === consultation.patientId);
                        return patient ? `${patient.name} ${patient.lastName}` : 'Paciente desconocido';
                    })();
                
                return `
                    <tr>
                        <td><strong>#${consultation.id}</strong></td>
                        <td>${patientName}</td>
                        <td>${formatDate(consultation.date)}</td>
                        <td>${consultation.time}</td>
                        <td>${consultation.type || 'Consulta general'}</td>
                        <td>
                            <span class="badge badge-${getStatusClass(consultation.status)}">
                                ${consultation.status}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewConsultation(${consultation.id})" title="Ver">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="editConsultation(${consultation.id})" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteConsultation(${consultation.id})" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            renderPagination();
        }

        // Get status badge class
        function getStatusClass(status) {
            switch(status) {
                case 'programada': return 'primary';
                case 'completada': return 'success';
                case 'cancelada': return 'danger';
                default: return 'secondary';
            }
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES');
        }

        // Render pagination
        function renderPagination() {
            const totalPages = Math.ceil(filteredConsultations.length / itemsPerPage);
            const pagination = document.getElementById('consultationsPagination');
            
            if (!pagination || totalPages <= 1) return;

            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage || i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationHTML += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                        </li>
                    `;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            // Next button
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;

            pagination.innerHTML = paginationHTML;
        }

        // Change page
        function changePage(page) {
            const totalPages = Math.ceil(filteredConsultations.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderConsultationsTable();
            }
        }

        // ⚠️ NOTA: Las funciones viewConsultation, editConsultation y deleteConsultation
        // están definidas en consultas.js con la estructura correcta de la base de datos.
        // NO redefinirlas aquí para evitar conflictos.
        
        /* FUNCIONES COMENTADAS - Usar las de consultas.js
        function viewConsultation(id) {
            const consultation = consultationsData.find(c => c.id === id);
            const patient = patientsData.find(p => p.id === consultation.patientId);
            const patientName = patient ? `${patient.name} ${patient.lastName}` : 'Paciente desconocido';
            
            if (consultation) {
                alert(`Detalles de la consulta:\\n\\nPaciente: ${patientName}\\nFecha: ${formatDate(consultation.date)}\\nHora: ${consultation.time}\\nTipo: ${consultation.type || 'Consulta general'}\\nEstado: ${consultation.status}\\nDiagnóstico: ${consultation.diagnosis || 'No especificado'}\\nNotas: ${consultation.notes || 'Sin notas'}`);
            }
        }

        function editConsultation(id) {
            const consultation = consultationsData.find(c => c.id === id);
            if (consultation) {
                alert('Funcionalidad de edición disponible. Consulta ID: ' + id);
            }
        }

        function deleteConsultation(id) {
            if (confirm('¿Está seguro de que desea eliminar esta consulta?')) {
                consultationsData = consultationsData.filter(c => c.id !== id);
                localStorage.setItem('consultationsData', JSON.stringify(consultationsData));
                refreshConsultations();
                showAlert('Consulta eliminada exitosamente', 'warning');
            }
        }
        */

        // Search and filter functionality
        function initializeFilters() {
            const searchInput = document.getElementById('searchConsultations');
            const patientFilter = document.getElementById('filterPatient');
            const statusFilter = document.getElementById('filterStatus');
            const dateFilter = document.getElementById('filterDate');

            if (searchInput) searchInput.addEventListener('input', filterConsultations);
            if (patientFilter) patientFilter.addEventListener('change', filterConsultations);
            if (statusFilter) statusFilter.addEventListener('change', filterConsultations);
            if (dateFilter) dateFilter.addEventListener('change', filterConsultations);
        }

        function filterConsultations() {
            const searchTerm = document.getElementById('searchConsultations')?.value.toLowerCase() || '';
            const patientFilter = document.getElementById('filterPatient')?.value || '';
            const statusFilter = document.getElementById('filterStatus')?.value || '';
            const dateFilter = document.getElementById('filterDate')?.value || '';

            filteredConsultations = consultationsData.filter(consultation => {
                const patient = patientsData.find(p => p.id === consultation.patientId);
                const patientName = patient ? `${patient.name} ${patient.lastName}`.toLowerCase() : '';
                
                const matchesSearch = !searchTerm || 
                    patientName.includes(searchTerm) ||
                    consultation.id.toString().includes(searchTerm) ||
                    (consultation.diagnosis && consultation.diagnosis.toLowerCase().includes(searchTerm));

                const matchesPatient = !patientFilter || consultation.patientId.toString() === patientFilter;
                const matchesStatus = !statusFilter || consultation.status === statusFilter;
                const matchesDate = !dateFilter || consultation.date === dateFilter;

                return matchesSearch && matchesPatient && matchesStatus && matchesDate;
            });

            currentPage = 1;
            renderConsultationsTable();
        }

        // Show alert messages
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadPatientsData();
            loadConsultationsData();
            loadPatientsDropdown();
            renderConsultationsTable();
            initializeFilters();
        });
    </script>
</body>
</html>
